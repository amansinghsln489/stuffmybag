<h1>My Wishlist</h1>
<div class="table-responsive">
  <table class="table table-bordered">
    <thead>
      <tr>
        <td class="text-center">Remove</td>
        <td class="text-center">Image</td>
        <td class="text-center">Product Name</td>
        <td class="text-center">Unit Price</td>
        <td class="text-center">Add to Cart</td>
      </tr>
    </thead>
    <tbody id="wishlist-table-body">
      <tr>
        <td colspan="5" class="text-center">Loading wishlist...</td>
      </tr>
    </tbody>
  </table>
</div>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    console.log(localStorage.getItem("wishlist"));
    loadWishlistItems();
  });

 function loadWishlistItems() {
  let wishlist = JSON.parse(localStorage.getItem("wishlist")) || [];
  let tableBody = document.getElementById("wishlist-table-body");

  if (wishlist.length === 0) {
    tableBody.innerHTML = '<tr><td colspan="5" class="text-center">Your wishlist is empty.</td></tr>';
    return;
  }

  // Loop through wishlist and fetch product details
  let productRequests = wishlist.map(productId =>
    fetch(`/products/${productId}.json`)
      .then(response => {
        console.log("Fetching:", `/products/${productId}.json`);
        return response.ok ? response.json() : null;
      })
      .then(data => data ? data.product : null) // Return product data only
      .catch(error => {
        console.error(`Error fetching product ${productId}:`, error);
        return null;
      })
  );

  // Wait for all fetch requests to complete
  Promise.all(productRequests).then(products => {
    let validProducts = products.filter(product => product !== null); // Remove null responses

    console.log("Valid Products:", validProducts); // Debugging

    if (validProducts.length === 0) {
      tableBody.innerHTML = '<tr><td colspan="5" class="text-center">No valid products found.</td></tr>';
      return;
    }

    // Loop through valid products and generate HTML
    let html = validProducts.map(product => `
      <tr>
        <td class="text-center">
          <button class="btn btn-danger" onclick="removeFromWishlist('${product.id}')">
            <i class="fa fa-times-circle"></i>
          </button>
        </td>
        <td class="text-center">
          <a href="${product.url}">
            <img src="${product.images[0]?.src || 'default-image.jpg'}" alt="${product.title}" class="img-thumbnail" width="80">
          </a>
        </td>
        <td class="text-center"><a href="${product.url}">${product.title}</a></td>
        <td class="text-center">${product.variants[0]?.price || 'N/A'}</td>
        <td class="text-center">
          <button class="btn btn-primary" onclick="addToCart('${product.variants[0]?.id || ''}')">Add to Cart</button>
        </td>
      </tr>
    `).join("");

    tableBody.innerHTML = html;
  });
}


  function removeFromWishlist(productId) {
    let wishlist = JSON.parse(localStorage.getItem("wishlist")) || [];
    wishlist = wishlist.filter(id => id !== productId);
    localStorage.setItem("wishlist", JSON.stringify(wishlist));
    loadWishlistItems();
  }

  function addToCart(variantID) {
    document.getElementById('product-select').value = variantID;
    document.getElementById('add-variant').submit();
  }
</script>
