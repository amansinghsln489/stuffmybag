{% if customer %}
  {% assign value = product.id %}
  {% capture productID %}{{ product.id }}{% endcapture %}
  {% for tag in customer.tags %}
    {% capture tagID %}{{ tag }}{% endcapture %}
    {% if tagID contains productID %}
      {% capture value %}x{{ tagID }}{% endcapture %}
    {% endif %}
    {% if value.size == 0 %}
      {% assign value = productID %}
    {% endif %}
  {% endfor %}

  {% unless value.size == 0 %}
    {% assign check = tag.size | minus: productID.size | modulo: 2 %}
    {% comment %}{% capture check %}{{ value.size | minus:productID.size | money_without_currency | times:100 | divided_by:2 }}{% endcapture %}{% endcomment %}
    {% assign check = check | split: '.' %}
    {% if check[1] contains '5' %}
      {% assign display = false -%}
    {%- else -%}
      {%- assign display = true %}
    {% endif %}
  {% endunless %}

  {% if display %}
    <span id="wishlist-count">0</span>
    <!-- Wishlist count display -->

    <button class="wishlist-button" data-product-id="{{ value }}" onclick="toggleWishlist(this)">
      ❤️ Add to Wishlist
    </button>

  {% else %}

  {% endif %}
{% else %}
  <button
    class="button btn-wishlist"
    type="button"
    data-toggle="tooltip"
    title="{{ 'products.product.add_to_wishlist' | t }}"
    data-original-title="{{ 'products.product.add_to_wishlist' | t }}"
    onclick="location.href='/account/login'"
  >
    <span>{{ 'products.product.add_to_wishlist' | t }}</span>
  </button>
{% endif %}

<script>
document.addEventListener("DOMContentLoaded", function () {
  loadWishlist();
});

async function validateProduct(productId) {
  try {
    let response = await fetch(`/products/${productId}.json`);
    return response.ok; // True if the product exists
  } catch (error) {
    return false;
  }
}

async function loadWishlist() {
  let wishlist = JSON.parse(localStorage.getItem("wishlist")) || [];
  let validWishlist = [];

  for (let productId of wishlist) {
    let isValid = await validateProduct(productId);
    if (isValid) {
      validWishlist.push(productId);
      updateWishlistButton(productId, true);
    }
  }

  // Remove invalid products from localStorage
  localStorage.setItem("wishlist", JSON.stringify(validWishlist));
  updateWishlistCount();
}

function toggleWishlist(button) {
  let productId = button.getAttribute("data-product-id");
  let wishlist = JSON.parse(localStorage.getItem("wishlist")) || [];
  alert(wishlist);
  let isInWishlist = wishlist.includes(productId);

  if (isInWishlist) {
    wishlist = wishlist.filter(id => id !== productId);
  } else {
    wishlist.push(productId);
  }

  localStorage.setItem("wishlist", JSON.stringify(wishlist));
  updateWishlistButton(productId, !isInWishlist);
  updateWishlistCount();
}

function updateWishlistButton(productId, isInWishlist) {
  document.querySelectorAll(`.wishlist-button[data-product-id="${productId}"]`).forEach(button => {
    button.innerHTML = isInWishlist ? "✔ Added to Wishlist" : "❤️ Add to Wishlist";
  });
}

function updateWishlistCount() {
  let wishlist = JSON.parse(localStorage.getItem("wishlist")) || [];
  let countElement = document.getElementById("wishlist-count");
  if (countElement) {
    countElement.textContent = wishlist.length;
  }
}
</script>
